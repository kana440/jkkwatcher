<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JKK Watcher - éƒ½å–¶ä½å®…ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 5px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .content {
      padding: 30px;
    }

    .status-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .status-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-dot.running {
      background: #10b981;
    }

    .status-dot.stopped {
      background: #6b7280;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    button {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-start {
      background: #10b981;
      color: white;
    }

    .btn-stop {
      background: #ef4444;
      color: white;
    }

    .btn-check {
      background: #3b82f6;
      color: white;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .section {
      margin-bottom: 30px;
    }

    .section h2 {
      font-size: 20px;
      margin-bottom: 15px;
      color: #1f2937;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 5px;
    }

    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-item input[type="checkbox"] {
      width: auto;
    }

    .btn-save {
      background: #667eea;
      color: white;
      width: 100%;
      margin-top: 15px;
    }

    .logs {
      max-height: 400px;
      overflow-y: auto;
    }

    .log-entry {
      background: #f9fafb;
      border-left: 4px solid #d1d5db;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .log-entry.found {
      border-left-color: #10b981;
      background: #ecfdf5;
    }

    .log-time {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .log-message {
      font-size: 14px;
      color: #1f2937;
    }

    .screenshot-link {
      display: inline-block;
      margin-top: 8px;
      color: #3b82f6;
      text-decoration: none;
      font-size: 13px;
    }

    .screenshot-link:hover {
      text-decoration: underline;
    }

    .info-text {
      font-size: 13px;
      color: #6b7280;
      margin-top: 5px;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 450px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal h3 {
      margin: 0 0 15px 0;
      font-size: 20px;
      color: #1f2937;
    }

    .modal p {
      margin: 0 0 20px 0;
      font-size: 14px;
      color: #6b7280;
      line-height: 1.6;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
    }

    .modal-buttons button {
      flex: 1;
    }

    .btn-warning {
      background: #f59e0b;
      color: white;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>JKK Watcher</h1>
      <p>éƒ½å–¶ä½å®…ç©ºãç‰©ä»¶ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ </p>
    </div>

    <div class="content">
      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="status-section">
        <div class="status-indicator">
          <div class="status-dot" id="statusDot"></div>
          <strong id="statusText">èª­ã¿è¾¼ã¿ä¸­...</strong>
        </div>
        <div id="statusDetails" style="font-size: 14px; color: #6b7280;"></div>
        <div class="button-group">
          <button class="btn-start" id="btnStart">â–¶ ç›£è¦–é–‹å§‹</button>
          <button class="btn-stop" id="btnStop">â¹ åœæ­¢</button>
          <button class="btn-check" id="btnCheck">ğŸ” æ‰‹å‹•ãƒã‚§ãƒƒã‚¯</button>
        </div>
      </div>

      <!-- è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="section">
        <h2>âš™ï¸ è¨­å®š</h2>
        <form id="configForm">
          <div class="form-group">
            <label>Gmailã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input type="email" id="gmailUser" required>
          </div>
          <div class="form-group">
            <label>Gmailã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="gmailPassword" required>
            <div class="info-text">â€» Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®2æ®µéšèªè¨¼ã‚’æœ‰åŠ¹ã«ã—ã€ã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„</div>
          </div>
          <div class="form-group">
            <label>é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å¯ï¼‰</label>
            <input type="text" id="recipients" required>
          </div>
          <div class="form-group">
            <label>ç‰©ä»¶åï¼ˆã‚«ãƒŠï¼‰</label>
            <input type="text" id="kanaName" required>
          </div>
          <div class="form-group">
            <label>å¸Œæœ›éšå±¤</label>
            <input type="text" id="kaisoFrom" required>
          </div>
          <div class="form-group">
            <label>åºŠé¢ç©</label>
            <select id="mensekiFrom">
              <option value="ã“ã ã‚ã‚‰ãªã„">ã“ã ã‚ã‚‰ãªã„</option>
              <option value="ï¼’ï¼">20ã¡ä»¥ä¸Š</option>
              <option value="ï¼“ï¼">30ã¡ä»¥ä¸Š</option>
              <option value="ï¼”ï¼">40ã¡ä»¥ä¸Š</option>
              <option value="ï¼•ï¼">50ã¡ä»¥ä¸Š</option>
              <option value="ï¼–ï¼">60ã¡ä»¥ä¸Š</option>
              <option value="ï¼—ï¼">70ã¡ä»¥ä¸Š</option>
              <option value="ï¼˜ï¼">80ã¡ä»¥ä¸Š</option>
              <option value="ï¼™ï¼">90ã¡ä»¥ä¸Š</option>
              <option value="ï¼‘ï¼ï¼">100ã¡ä»¥ä¸Š</option>
            </select>
          </div>
          <div class="form-group">
            <label>é–“å–ã‚Š</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="madori1">
                <label for="madori1" style="margin: 0;">1R/1K/1LDK</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="madori2">
                <label for="madori2" style="margin: 0;">2K/2LDK</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="madori3">
                <label for="madori3" style="margin: 0;">3K/3LDK</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="madori4">
                <label for="madori4" style="margin: 0;">4Kä»¥ä¸Š</label>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>ç›£è¦–é–“éš”ï¼ˆç§’ï¼‰</label>
            <input type="number" id="intervalSeconds" min="60" required>
          </div>
          <div class="form-group">
            <label>ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ</label>
            <select id="headless">
              <option value="false">Noï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚’è¡¨ç¤ºï¼‰</option>
              <option value="true">Yesï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œï¼‰</option>
            </select>
            <div class="info-text">â€» ãƒ‡ãƒãƒƒã‚°æ™‚ã¯ã€ŒNoã€ã‚’é¸æŠã™ã‚‹ã¨ãƒ–ãƒ©ã‚¦ã‚¶ã®å‹•ä½œã‚’ç¢ºèªã§ãã¾ã™</div>
          </div>
          <div class="form-group">
            <label>ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ãŸã‚‰ã‚µãƒ¼ãƒãƒ¼ã‚‚åœæ­¢</label>
            <select id="autoShutdown">
              <option value="false">Noï¼ˆã‚µãƒ¼ãƒãƒ¼ã¯å®Ÿè¡Œã—ç¶šã‘ã‚‹ï¼‰</option>
              <option value="true">Yesï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ãŸã‚‰åœæ­¢ï¼‰</option>
            </select>
            <div class="info-text">â€» ã€ŒYesã€ã‚’é¸æŠã™ã‚‹ã¨ã€å…¨ã¦ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ãŸã¨ãã«ã‚µãƒ¼ãƒãƒ¼ã‚‚è‡ªå‹•çš„ã«åœæ­¢ã—ã¾ã™</div>
          </div>
          <button type="submit" class="btn-save">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
        </form>
      </div>

      <!-- ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <h2 style="margin: 0;">ğŸ“‹ å®Ÿè¡Œå±¥æ­´</h2>
          <button id="btnClearLogs" style="flex: none; padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer;">
            ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
          </button>
        </div>
        <div class="info-text" style="margin-bottom: 10px;">
          â€» ãƒ’ãƒƒãƒˆãªã—ã®ãƒ­ã‚°ã¯æœ€é•·1æ—¥é–“ã®ã¿ä¿æŒã•ã‚Œã¾ã™
        </div>
        <div class="logs" id="logsContainer">
          <p style="color: #6b7280; text-align: center;">ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>
      </div>
    </div>
  </div>

  <!-- æœªä¿å­˜ã®å¤‰æ›´ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="unsavedModal">
    <div class="modal">
      <h3>âš ï¸ æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™</h3>
      <p>è¨­å®šãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã¾ã ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br><br>
      <strong>å¤‰æ›´ã—ã¦å®Ÿè¡Œ:</strong> ç¾åœ¨ã®è¨­å®šå€¤ã§æ‰‹å‹•ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯æ›´æ–°ã•ã‚Œã¾ã›ã‚“ï¼‰<br><br>
      <strong>ã‚­ãƒ£ãƒ³ã‚»ãƒ«:</strong> è¨­å®šã‚’ä¿å­˜ã—ã¦ã‹ã‚‰å†åº¦å®Ÿè¡Œã—ã¦ãã ã•ã„</p>
      <div class="modal-buttons">
        <button class="btn-secondary" id="btnModalCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-warning" id="btnModalExecute">âš¡ å¤‰æ›´ã—ã¦å®Ÿè¡Œ</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '';
    let hasUnsavedChanges = false;
    let originalConfigJson = '';
    let ws = null;
    let reconnectTimeout = null;

    // è¨­å®šå¤‰æ›´ã‚’æ¤œçŸ¥
    function checkForChanges() {
      const currentConfigJson = JSON.stringify(getCurrentFormConfig());
      hasUnsavedChanges = currentConfigJson !== originalConfigJson;
    }

    // ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¨­å®šã‚’å–å¾—
    function getCurrentFormConfig() {
      return {
        interval_seconds: parseInt(document.getElementById('intervalSeconds').value),
        headless: document.getElementById('headless').value === 'true',
        auto_shutdown: document.getElementById('autoShutdown').value === 'true',
        gmail: {
          user: document.getElementById('gmailUser').value,
          password: document.getElementById('gmailPassword').value,
        },
        recipients: {
          sender: document.getElementById('gmailUser').value,
          to: document.getElementById('recipients').value.split(',').map(s => s.trim()),
        },
        search: {
          kana_name: document.getElementById('kanaName').value,
          kaiso_from: document.getElementById('kaisoFrom').value,
          menseki_from: document.getElementById('mensekiFrom').value,
          madori: {
            madori_1R1K_1LDK: document.getElementById('madori1').checked,
            madori_2K_2LDK: document.getElementById('madori2').checked,
            madori_3K_3LDK: document.getElementById('madori3').checked,
            madori_4K_up: document.getElementById('madori4').checked,
          },
        },
      };
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
    async function updateStatus() {
      try {
        const res = await fetch(`${API_BASE}/api/status`);
        const status = await res.json();

        const dot = document.getElementById('statusDot');
        const text = document.getElementById('statusText');
        const details = document.getElementById('statusDetails');

        if (status.isRunning) {
          dot.className = 'status-dot running';
          text.textContent = 'ç›£è¦–ä¸­';
          document.getElementById('btnStart').disabled = true;
          document.getElementById('btnStop').disabled = false;
        } else {
          dot.className = 'status-dot stopped';
          text.textContent = 'åœæ­¢ä¸­';
          document.getElementById('btnStart').disabled = false;
          document.getElementById('btnStop').disabled = true;
        }

        let detailsHtml = `ç·ãƒã‚§ãƒƒã‚¯å›æ•°: ${status.totalChecks}å›`;
        if (status.lastCheckTime) {
          detailsHtml += `<br>æœ€çµ‚ãƒã‚§ãƒƒã‚¯: ${new Date(status.lastCheckTime).toLocaleString('ja-JP')}`;
        }
        if (status.lastResult) {
          detailsHtml += `<br>çµæœ: ${status.lastResult}`;
        }
        details.innerHTML = detailsHtml;
      } catch (error) {
        console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // è¨­å®šã‚’èª­ã¿è¾¼ã¿
    async function loadConfig() {
      try {
        const res = await fetch(`${API_BASE}/api/config`);
        const config = await res.json();

        document.getElementById('gmailUser').value = config.gmail.user;
        document.getElementById('gmailPassword').value = config.gmail.password;
        document.getElementById('recipients').value = config.recipients.to.join(', ');
        document.getElementById('kanaName').value = config.search.kana_name;
        document.getElementById('kaisoFrom').value = config.search.kaiso_from;
        document.getElementById('mensekiFrom').value = config.search.menseki_from;
        document.getElementById('madori1').checked = config.search.madori.madori_1R1K_1LDK;
        document.getElementById('madori2').checked = config.search.madori.madori_2K_2LDK;
        document.getElementById('madori3').checked = config.search.madori.madori_3K_3LDK;
        document.getElementById('madori4').checked = config.search.madori.madori_4K_up;
        document.getElementById('intervalSeconds').value = config.interval_seconds;
        document.getElementById('headless').value = String(config.headless ?? false);
        document.getElementById('autoShutdown').value = String(config.auto_shutdown ?? false);

        // èª­ã¿è¾¼ã‚“ã è¨­å®šã‚’ä¿å­˜
        originalConfigJson = JSON.stringify(config);
        hasUnsavedChanges = false;
      } catch (error) {
        console.error('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
    let currentLogPage = 0;
    const LOGS_PER_PAGE = 10;
    let allLogs = [];

    async function loadLogs() {
      try {
        const res = await fetch(`${API_BASE}/api/logs?limit=100`);
        allLogs = await res.json();
        currentLogPage = 0;
        displayLogs();
      } catch (error) {
        console.error('ãƒ­ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    function displayLogs() {
      const container = document.getElementById('logsContainer');

      if (allLogs.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center;">ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      const start = currentLogPage * LOGS_PER_PAGE;
      const end = start + LOGS_PER_PAGE;
      const logsToDisplay = allLogs.slice(start, end);

      const logsHtml = logsToDisplay.map(log => `
        <div class="log-entry ${log.found ? 'found' : ''}">
          <div class="log-time">${new Date(log.timestamp).toLocaleString('ja-JP')}</div>
          <div class="log-message">${log.message}</div>
          ${log.screenshotPath ? `<a href="/api/screenshot/${log.screenshotPath.split('/').pop()}" target="_blank" class="screenshot-link">ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’è¡¨ç¤º</a>` : ''}
        </div>
      `).join('');

      const totalPages = Math.ceil(allLogs.length / LOGS_PER_PAGE);
      const paginationHtml = totalPages > 1 ? `
        <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 15px;">
          <button id="btnPrevPage" ${currentLogPage === 0 ? 'disabled' : ''} style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; ${currentLogPage === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">â† å‰ã¸</button>
          <span style="font-size: 13px; color: #6b7280;">${currentLogPage + 1} / ${totalPages} ãƒšãƒ¼ã‚¸ (å…¨${allLogs.length}ä»¶)</span>
          <button id="btnNextPage" ${currentLogPage >= totalPages - 1 ? 'disabled' : ''} style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; ${currentLogPage >= totalPages - 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">æ¬¡ã¸ â†’</button>
        </div>
      ` : `<div style="text-align: center; margin-top: 10px; font-size: 13px; color: #6b7280;">å…¨${allLogs.length}ä»¶</div>`;

      container.innerHTML = logsHtml + paginationHtml;

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
      if (totalPages > 1) {
        document.getElementById('btnPrevPage')?.addEventListener('click', () => {
          if (currentLogPage > 0) {
            currentLogPage--;
            displayLogs();
          }
        });
        document.getElementById('btnNextPage')?.addEventListener('click', () => {
          if (currentLogPage < totalPages - 1) {
            currentLogPage++;
            displayLogs();
          }
        });
      }
    }

    // ç›£è¦–é–‹å§‹
    document.getElementById('btnStart').addEventListener('click', async () => {
      try {
        const res = await fetch(`${API_BASE}/api/start`, { method: 'POST' });
        const result = await res.json();
        alert(result.message);
        updateStatus();
      } catch (error) {
        alert('ç›£è¦–ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });

    // ç›£è¦–åœæ­¢
    document.getElementById('btnStop').addEventListener('click', async () => {
      try {
        const res = await fetch(`${API_BASE}/api/stop`, { method: 'POST' });
        const result = await res.json();
        alert(result.message);
        updateStatus();
      } catch (error) {
        alert('ç›£è¦–ã®åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });

    // æ‰‹å‹•ãƒã‚§ãƒƒã‚¯
    document.getElementById('btnCheck').addEventListener('click', async () => {
      checkForChanges();

      if (hasUnsavedChanges) {
        // æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        document.getElementById('unsavedModal').classList.add('show');
      } else {
        // å¤‰æ›´ãŒãªã„å ´åˆã¯é€šå¸¸ã®æ‰‹å‹•ãƒã‚§ãƒƒã‚¯
        await executeCheck();
      }
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ« - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
    document.getElementById('btnModalCancel').addEventListener('click', () => {
      document.getElementById('unsavedModal').classList.remove('show');
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ« - å¤‰æ›´ã—ã¦å®Ÿè¡Œãƒœã‚¿ãƒ³
    document.getElementById('btnModalExecute').addEventListener('click', async () => {
      document.getElementById('unsavedModal').classList.remove('show');
      await executeCheckWithChanges();
    });

    // æ‰‹å‹•ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œï¼ˆä¿å­˜æ¸ˆã¿è¨­å®šã‚’ä½¿ç”¨ï¼‰
    async function executeCheck() {
      try {
        const res = await fetch(`${API_BASE}/api/check`, { method: 'POST' });
        const result = await res.json();
        alert(result.message);
        setTimeout(() => {
          updateStatus();
          loadLogs();
        }, 2000);
      } catch (error) {
        alert('ãƒã‚§ãƒƒã‚¯ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // æ‰‹å‹•ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œï¼ˆç¾åœ¨ã®è¨­å®šã‚’ä½¿ç”¨ã€ä¿å­˜ã—ãªã„ï¼‰
    async function executeCheckWithChanges() {
      try {
        const config = getCurrentFormConfig();

        // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã§ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (!config.gmail.user || !config.gmail.password) {
          alert('Gmailè¨­å®šãŒä¸æ­£ã§ã™');
          return;
        }
        if (!config.recipients.sender || config.recipients.to.length === 0) {
          alert('ãƒ¡ãƒ¼ãƒ«é€ä¿¡å…ˆè¨­å®šãŒä¸æ­£ã§ã™');
          return;
        }
        if (!config.search.kana_name) {
          alert('æ¤œç´¢æ¡ä»¶ï¼ˆç‰©ä»¶åï¼‰ãŒä¸æ­£ã§ã™');
          return;
        }
        if (config.interval_seconds < 60) {
          alert('ç›£è¦–é–“éš”ã¯60ç§’ä»¥ä¸Šã«è¨­å®šã—ã¦ãã ã•ã„');
          return;
        }

        const res = await fetch(`${API_BASE}/api/check-with-config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config),
        });
        const result = await res.json();

        if (res.ok) {
          alert(result.message);
          setTimeout(() => {
            updateStatus();
            loadLogs();
          }, 2000);
        } else {
          alert(`ã‚¨ãƒ©ãƒ¼: ${result.error}`);
        }
      } catch (error) {
        alert('ãƒã‚§ãƒƒã‚¯ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error instanceof Error ? error.message : String(error)));
      }
    }

    // è¨­å®šä¿å­˜
    document.getElementById('configForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const config = {
        interval_seconds: parseInt(document.getElementById('intervalSeconds').value),
        headless: document.getElementById('headless').value === 'true',
        auto_shutdown: document.getElementById('autoShutdown').value === 'true',
        gmail: {
          user: document.getElementById('gmailUser').value,
          password: document.getElementById('gmailPassword').value,
        },
        recipients: {
          sender: document.getElementById('gmailUser').value,
          to: document.getElementById('recipients').value.split(',').map(s => s.trim()),
        },
        search: {
          kana_name: document.getElementById('kanaName').value,
          kaiso_from: document.getElementById('kaisoFrom').value,
          menseki_from: document.getElementById('mensekiFrom').value,
          madori: {
            madori_1R1K_1LDK: document.getElementById('madori1').checked,
            madori_2K_2LDK: document.getElementById('madori2').checked,
            madori_3K_3LDK: document.getElementById('madori3').checked,
            madori_4K_up: document.getElementById('madori4').checked,
          },
        },
      };

      try {
        const res = await fetch(`${API_BASE}/api/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config),
        });

        if (res.ok) {
          alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          // ä¿å­˜å¾Œã€originalConfigJsonã‚’æ›´æ–°
          originalConfigJson = JSON.stringify(config);
          hasUnsavedChanges = false;
        } else {
          const error = await res.json();
          alert(`ã‚¨ãƒ©ãƒ¼: ${error.error}`);
        }
      } catch (error) {
        alert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });

    // ãƒ­ã‚°ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
    document.getElementById('btnClearLogs').addEventListener('click', async () => {
      if (!confirm('å®Ÿè¡Œå±¥æ­´ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/logs`, { method: 'DELETE' });
        const result = await res.json();
        if (res.ok) {
          alert(result.message);
          loadLogs();
        } else {
          alert(`ã‚¨ãƒ©ãƒ¼: ${result.error}`);
        }
      } catch (error) {
        alert('ãƒ­ã‚°ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });

    // ãƒ•ã‚©ãƒ¼ãƒ ã®å¤‰æ›´ã‚’ç›£è¦–
    document.getElementById('configForm').addEventListener('input', checkForChanges);

    // WebSocketæ¥ç¶šã‚’ç¢ºç«‹
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws`;

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('WebSocketæ¥ç¶šç¢ºç«‹');
        if (reconnectTimeout) {
          clearTimeout(reconnectTimeout);
          reconnectTimeout = null;
        }
      };

      ws.onmessage = (event) => {
        try {
          const message = JSON.parse(event.data);
          handleWebSocketMessage(message);
        } catch (error) {
          console.error('WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        }
      };

      ws.onerror = (error) => {
        console.error('WebSocketã‚¨ãƒ©ãƒ¼:', error);
      };

      ws.onclose = () => {
        console.log('WebSocketæ¥ç¶šåˆ‡æ–­');
        // è‡ªå‹•å†æ¥ç¶š
        reconnectTimeout = setTimeout(() => {
          console.log('WebSocketå†æ¥ç¶šã‚’è©¦è¡Œä¸­...');
          connectWebSocket();
        }, 3000);
      };
    }

    // WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†
    function handleWebSocketMessage(message) {
      console.log('WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡:', message);

      switch (message.type) {
        case 'initial_state':
          // åˆæœŸçŠ¶æ…‹ã‚’å—ä¿¡
          updateStatusFromData(message.data.status);
          displayLogsFromData(message.data.logs);
          break;

        case 'status_update':
          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
          updateStatusFromData(message.data);
          break;

        case 'log_added':
          // æ–°ã—ã„ãƒ­ã‚°ãŒè¿½åŠ ã•ã‚ŒãŸ
          prependLog(message.data);
          break;

        case 'progress':
          // é€²è¡ŒçŠ¶æ³ã®æ›´æ–°
          showProgress(message.data);
          break;

        case 'notification':
          // é€šçŸ¥ã‚’è¡¨ç¤º
          showNotification(message.data);
          break;

        case 'pong':
          // Pingå¿œç­”
          break;

        default:
          console.warn('æœªçŸ¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—:', message.type);
      }
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ›´æ–°
    function updateStatusFromData(status) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      const details = document.getElementById('statusDetails');

      if (status.isRunning) {
        dot.className = 'status-dot running';
        text.textContent = 'ç›£è¦–ä¸­';
        document.getElementById('btnStart').disabled = true;
        document.getElementById('btnStop').disabled = false;
      } else {
        dot.className = 'status-dot stopped';
        text.textContent = 'åœæ­¢ä¸­';
        document.getElementById('btnStart').disabled = false;
        document.getElementById('btnStop').disabled = true;
      }

      let detailsHtml = `ç·ãƒã‚§ãƒƒã‚¯å›æ•°: ${status.totalChecks}å›`;
      if (status.lastCheckTime) {
        detailsHtml += `<br>æœ€çµ‚ãƒã‚§ãƒƒã‚¯: ${new Date(status.lastCheckTime).toLocaleString('ja-JP')}`;
      }
      if (status.lastResult) {
        detailsHtml += `<br>çµæœ: ${status.lastResult}`;
      }
      details.innerHTML = detailsHtml;
    }

    // ãƒ­ã‚°ã‚’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¡¨ç¤º
    function displayLogsFromData(logs) {
      allLogs = logs;
      currentLogPage = 0;
      displayLogs();
    }

    // æ–°ã—ã„ãƒ­ã‚°ã‚’å…ˆé ­ã«è¿½åŠ 
    function prependLog(log) {
      allLogs.unshift(log);
      currentLogPage = 0;
      displayLogs();
    }

    // é€²è¡ŒçŠ¶æ³ã‚’è¡¨ç¤º
    function showProgress(data) {
      const details = document.getElementById('statusDetails');
      const currentHtml = details.innerHTML;
      details.innerHTML = currentHtml + `<br><small style="color: #3b82f6;">â–¶ ${data.message}</small>`;

      // 3ç§’å¾Œã«é€²è¡ŒçŠ¶æ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
      setTimeout(() => {
        if (details.innerHTML.includes(data.message)) {
          details.innerHTML = currentHtml;
        }
      }, 3000);
    }

    // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¡¨ç¤º
    function showNotification(data) {
      // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('JKK Watcher', {
          body: data.message,
          icon: data.type === 'success' ? 'âœ…' : data.type === 'error' ? 'âŒ' : 'â„¹ï¸',
        });
      }

      // ã‚¢ãƒ©ãƒ¼ãƒˆã§ã‚‚è¡¨ç¤º
      if (data.type === 'success') {
        alert('ğŸ‰ ' + data.message);
      }
    }

    // é€šçŸ¥æ¨©é™ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    // åˆæœŸåŒ–
    loadConfig();
    updateStatus();
    loadLogs();
    connectWebSocket();
    requestNotificationPermission();

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: WebSocketæ¥ç¶šã§ããªã„å ´åˆã«å‚™ãˆã¦ãƒãƒ¼ãƒªãƒ³ã‚°ã‚‚æ®‹ã™ï¼ˆé »åº¦ã‚’ä¸‹ã’ã‚‹ï¼‰
    setInterval(() => {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        // WebSocketãŒåˆ‡æ–­ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ãƒãƒ¼ãƒªãƒ³ã‚°
        updateStatus();
        loadLogs();
      }
    }, 30000); // 30ç§’ã«1å›ï¼ˆå…ƒã®5ç§’ã‹ã‚‰å¢—ã‚„ã™ï¼‰
  </script>
</body>
</html>