# JKK Watcher - 都営住宅空き物件監視システム

都営住宅の空き物件を自動で監視し、物件が見つかった際にメール通知するシステムです。

## 特徴

- 🌐 **ブラウザUI**: Webブラウザから簡単に設定・操作
- 🔄 **自動監視**: 設定した間隔で自動的にチェック
- 📧 **メール通知**: 空き物件が見つかったら自動でメール送信
- 📸 **スクリーンショット**: 検索結果を画像で保存
- 📊 **履歴管理**: 実行履歴をブラウザで確認可能（ページネーション対応）
- 🔍 **デバッグモード**: ヘッドレスモードON/OFF切替可能
- ⚠️ **未保存警告**: 設定変更時の警告とプレビュー実行
- 🗑️ **ログクリーンアップ**: 1日以上前のヒットなしログは自動削除
- 💻 **クロスプラットフォーム**: Windows & Mac対応

## 必要なもの

- インターネット接続
- Gmailアカウント（メール送信用）
  - 2段階認証を有効化
  - アプリパスワードの生成が必要

## 使い方

### 初回セットアップ

1. **設定ファイルを作成**
   ```bash
   # config.example.yaml をコピーして config.yaml を作成
   cp config.example.yaml config.yaml
   ```

2. **設定ファイルを編集**
   - `config.yaml` を開く
   - Gmailアドレスとアプリパスワードを設定
   - 検索条件（物件名、階層、床面積など）を設定

3. **起動スクリプトを実行**
   - **Mac/Linux**: `./run.sh`
   - **Windows**: `run.bat` をダブルクリック

4. **初回起動時**
   - 自動的に必要なツール（Bun、Playwright）をインストール
   - 数分かかる場合があります
   - 完了すると自動でブラウザが開きます

### 通常の使い方

1. `run.sh` または `run.bat` を実行
2. ブラウザで `http://localhost:3000` が開く
3. 設定を確認・編集
4. 「監視開始」ボタンをクリック
5. バックグラウンドで自動監視が開始されます

### 監視の停止

- ブラウザで「停止」ボタンをクリック
- または、ターミナルで `Ctrl+C`

## ブラウザUI

### ステータスセクション
- 現在の監視状態を表示（監視中/停止中）
- 最終チェック時刻と結果を表示
- 総チェック回数を表示
- **監視開始**: 自動監視を開始
- **停止**: 監視を停止
- **手動チェック**: 1回だけチェックを実行

### 設定セクション
- **Gmail設定**: メールアドレスとアプリパスワード
- **送信先メールアドレス**: カンマ区切りで複数指定可能
- **検索条件**:
  - 物件名（カナ）
  - 希望階層
  - 床面積（こだわらない、20㎡以上、30㎡以上...）
  - 間取り（1R/1K/1LDK、2K/2LDK、3K/3LDK、4K以上）
- **監視間隔**: 秒単位（最小60秒）
- **ヘッドレスモード**:
  - No（ブラウザを表示）: デバッグ時に推奨
  - Yes（バックグラウンド実行）: 通常の監視に推奨

#### 未保存の変更機能
- 設定を変更すると自動検知
- 保存せずに「手動チェック」を押すとモーダルが表示
- **変更して実行**: 現在の設定値でプレビュー実行（保存しない）
- **キャンセル**: 設定を保存してから再度実行

### 実行履歴
- 過去のチェック結果を10件ずつページネーション表示
- ヒットしたログは緑色で強調表示
- スクリーンショットの閲覧（物件発見時）
- **クリアボタン**: 全ログを削除
- **自動クリーンアップ**: ヒットなしのログは1日後に自動削除（ヒットしたログは永久保持）

## Gmail設定

### アプリパスワードの取得方法

1. Googleアカウントにログイン
2. セキュリティ設定を開く
3. 2段階認証を有効化
4. 「アプリパスワード」を生成
5. 生成されたパスワードを `config.yaml` に設定

詳細: https://support.google.com/accounts/answer/185833

## トラブルシューティング

### ブラウザが開かない
- 手動で `http://localhost:3000` にアクセス

### メールが送信されない
- Gmail設定を確認
- アプリパスワードが正しいか確認
- 2段階認証が有効になっているか確認

### 検索がうまくいかない
- ヘッドレスモードを「No」にしてブラウザの動作を確認
- 検索条件を確認
- 物件名（カナ）が正しいか確認
- 手動チェックで動作確認

### 設定バリデーションエラー
- 監視間隔は60秒以上に設定してください
- Gmail設定とメール送信先を正しく設定してください
- 検索条件（物件名）を入力してください

## ファイル構成

```
jkkwatcher/
├── run.sh                  # Mac/Linux起動スクリプト
├── run.bat                 # Windows起動スクリプト
├── config.example.yaml     # 設定ファイルのサンプル
├── config.yaml            # 設定ファイル（Git管理対象外）
├── index.ts               # メインエントリーポイント
├── src/
│   ├── config.ts          # 設定管理・バリデーション
│   ├── scraper.ts         # スクレイピングロジック
│   ├── notifier.ts        # メール通知
│   ├── watcher.ts         # 監視制御・ログ管理
│   └── server.ts          # Webサーバー・API
├── public/
│   └── index.html         # Web UI（設定、ログ表示、モーダル）
└── logs/                  # ログ・スクリーンショット保存先（Git管理対象外）
```

## 技術スタック

- **Bun**: JavaScript/TypeScriptランタイム
- **Playwright**: ブラウザ自動化
- **TypeScript**: 型安全な開発
- **Nodemailer**: メール送信
- **js-yaml**: YAML設定ファイル管理

## セキュリティ

- `config.yaml` は `.gitignore` に含まれており、Gitリポジトリにはアップロードされません
- Gmail アプリパスワードなどの機密情報は `config.yaml` にのみ保存してください
- `config.example.yaml` をテンプレートとして使用してください

## 配布方法

Playwrightはブラウザバイナリを使用するため、単一の実行ファイルにコンパイルすることはできません。
以下の方法で配布してください：

### ソースコード配布（推奨）

プロジェクトディレクトリ全体を配布し、ユーザーが初回起動時に自動セットアップを実行する方法です。

**配布するファイル：**
```
jkkwatcher/
├── run.sh              # Mac/Linux起動スクリプト
├── run.bat             # Windows起動スクリプト
├── index.ts
├── src/
├── public/
├── config.example.yaml
├── package.json
├── tsconfig.json
└── README.md
```

**ユーザー側の手順：**
1. ディレクトリを展開
2. `config.example.yaml` をコピーして `config.yaml` を作成し、設定を編集
3. `run.sh` (Mac/Linux) または `run.bat` (Windows) を実行
4. 初回起動時に自動的に Bun と Playwright がインストールされます

### ZIP配布

```bash
# node_modules と logs を除外して ZIP 圧縮
zip -r jkkwatcher.zip . -x "node_modules/*" "logs/*" "config.yaml"
```

## ライセンス

個人利用・商用利用ともに自由にご利用ください。

## サポート

問題が発生した場合は、以下を確認してください:
- `logs/` ディレクトリ内のログファイル
- ターミナルのエラーメッセージ
- ブラウザのコンソールログ
- ヘッドレスモードを「No」にして動作を確認
